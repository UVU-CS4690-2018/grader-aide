<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>GraderAide</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.min.js"></script>
  <style>
      body {
          /* Same as UVU.edu */
          font-family: "stratum-1-web", Arial, "Lucida Grande", sans-serif;
      }
     .clickable {
       cursor: pointer;
     }
     .uvu-borders {
         border: 1px solid #275d39;
         border-radius: 5px;
     }
     .uvu-button {
         background-color: #275d39;
         color: white;
         font-weight: bold;
         border: 1px solid #275d39;
         border-radius: 5px;
         padding: 5px 20px 5px 20px;
     }
      /* UVU Green: #275d39 */
  </style>
</head>
<body>
  <div class="container" id="app">
    <div class="row">
      <div class="col-10 offset-1 col-sm-8 offset-sm-2 col-md-6 offset-md-3">
        <h1 v-if="!editTitle" @dblclick="editTitle = true">{{ assignmentName }}</h1>
        <input v-else type="text" v-model="assignmentName" @keyup.enter="editTitle = false">

        <!-- Amount of points title and the add and edit buttons -->
        <div class="row">
          <h4 class="col-3">{{totalPts}} pts</h4>
          <span class="col-2 offset-7 float-right">
            <img src="img/undoBlack.svg" class="clickable float-right" @click="restoreRule()" title="Restore Rule">
            <img src="img/plusGreen.svg" v-show="!plusFormActive" class="clickable float-right" @click="plusFormActive=true" title="Add Rule">
          </span>
        </div>

        <!-- List of all rules -->
        <div v-for="(rule, i) of rules" :key="rule.desc">
          <input type="checkbox" name="rubric" :value="rule" v-model="selectedRules">
              {{rule.pts | positive}} - {{rule.desc}}
              <span class="clickable float-right">
                <img src="img/pencilBlack.svg" @click="editRule(i)" title="Edit Rule">
                <img src="img/xRed.svg" @click="removeRule(i)" title="Remove Rule">
              </span><br>
          </input>
        </div>

        <!-- Add new rule form -->
        <div v-if="plusFormActive">
          <input type="text" class="col-xl-2" v-model.number="addNum" @keyup.enter.lazy="addRule()" placeholder="Rule Points" title="Rule Points">
          <input type="text" class="col-xl-9" v-model.trim="addDesc" @keyup.enter.lazy="addRule()" placeholder="Rule Description" title="Rule description" autofocus>
          <img src="img/plusGreen.svg" class="clickable float-right" @click="addRule()" title="Open add fields">
        </div>

        <!-- Results area -->
        <hr>
        <div class="alert" :class="{'alert-success': pointsSuccess, 'alert-warning': !pointsSuccess}" role="alert">
          <span v-for="selectedRule of selectedRules">{{selectedRule.pts | positive}} {{selectedRule.desc}}<br></span>
          <b v-if="pointsSuccess">Good Job</b>
          <hr> {{actualPts}}
        </div>

        <!-- submit buttons -->
        <button class="uvu-button" @click="saveLab()">save lab</button>
        <button class="uvu-button" @click="saveGrading()">save grading</button>
        <select class="uvu-borders" style="padding: 5px 0 6px 0;" v-model="selectedStudent">
            <option v-for="student in students" :value="student.UVID">{{ student.name }}</option>
        </select>
      </div>
	  <!-- comments div-->
	<div class="col-xl-3 card commentPadding">
		<ul class="list-group list-group-flush mb-1">
			<li v-for="(comment, i) of commentsObj.comments" class="list-group-item">
				<div v-if="i != activeCommentEdit">
					<img src="img/xRed.svg" class="float-right clickable" @click="removeComment(i)" title="Remove Comment">
					<img src="img/pencilBlack.svg" class="float-right clickable mr-1" @click="editComment(i)" title="Edit Comment">
				  {{comment.comment}}
				</div>
				<div v-if="i == activeCommentEdit">
					<input type="text" class="form-control" v-model="activeCommentEditText">
					<input type="submit" @click="submitEditedComment(i)" class="btn btn-primary mt-1" >
				</div>
			</li>
			<b class="card-title ml-3 mt-3 mb-1">New Comment</b>
			<div @click="addComment()">
				<input type="text" placeholder="..." class="form-control" v-model="commentsObj.newComment">
				<input type="submit" class="btn btn-primary mt-1" >
				<span v-if="deletedComments.length" class="btn btn-primary clickable float-right mt-1" @click="restoreComment()">undo </span>
			</div>

		</ul>
	</div>
    </div>
  </div>

  <script>
    /* global Vue */
    /* global axios */
    let app = new Vue({
      el: '#app',
      data: {
        assignmentName: null,
        totalPts: 0,
        rules: [],
        //GUI state variables
        students: [],
        selectedStudent: null,
        selectedRules: [],
        deletedRules: [],
        addNum: 0,
        addDesc: null,
        plusFormActive: false,
        editTitle: false,
		commentsObj: {
            comments: [],
            newComment: "",
            deleted: {}
        },
        deletedComments: [],//don't save/load me. I'm ephemeral
        activeCommentEdit: null,
        activeCommentEditText: null,
        ruleSpans: [],
        deletedRuleSpans: [],
        ruleDivCount: 0,
        ruleEdit: false
      },
      filters: {
        positive: function(num) {
          if (num > 0) return `+${num}`;
          return num;
        }
      },
      computed: {
        actualPts: function() { //add up all selected pts and subtract from totalPts
          return this.selectedRules.reduce((acc, el) => acc + el.pts, this.totalPts);
        },
        pointsSuccess: function(){
            return this.actualPts >= this.totalPts;
        }
      },
      methods: {
        removeRule: function(i) {
            this.deletedRules.push(this.rules.splice(i,1)[0]);
        },
        restoreRule: function() {
            if (this.deletedRules.length > 0) this.rules.push(this.deletedRules.pop());
        },
        addRule: function(){
          if (this.addNum === 0 || this.addDesc === "") return;
          this.rules.push({ pts: Number(this.addNum), desc: this.addDesc});
          this.addNum = null;
          this.addDesc = null;
          this.plusFormActive = false;
          let currentRuleSpan = document.getElementById('lastRuleSpan');
            if(currentRuleSpan != null){
                currentRuleSpan.id = `ruleSpan${this.ruleDivCount}`;
                //this.ruleSpans.unshift({spanId: currentRuleSpan.id});
                console.log(`just created span with id: ${currentRuleSpan.id}`);
                this.ruleDivCount++;

            }
            else{
                // currentRuleSpan.id = `ruleSpan${this.ruleDivCount}`;
            currentRuleSpan.id = `lastRuleSpan`;
            console.log(`just created div with id: ${lastRuleSpan}`);
            }
        },
          editRule: function(i) {
            let rulesSize = this.rules.length-1;
            // console.log(`rulesSize i = ${rulesSize}`);
            let spanToEdit = document.getElementById("lastRuleSpan");
            if(i !== rulesSize){
                spanToEdit = document.getElementById(`ruleSpan${i}`);
            }
             console.log(`spanToEdit = ${spanToEdit.id}`);
            console.log(`editRule i = ${i}`);
             //
             spanToEdit.innerHTML = `<input id="inputNum" type="text" class="col-xl-2" v-model.number="addNum" placeholder="Rule Points" title="Rule Points">
            <input type="text" id="inputDesc" class="col-xl-9" v-model.trim="addDesc"  placeholder="Rule Description" title="Rule description" autofocus>`;
        },
        saveLab: function(){
            axios.post('http://localhost:3000/assignments', {//TODO json-server won't upsert information with PUT, it only inserts.
                    id: this.assignmentName,
                    totalPts: this.totalPts,
                    rules: this.rules
            })
            .then(function (res) {
                console.log(res);
            })
            .catch(function (err) {
                console.log(err);
            });
        },
        saveGrading: function(){
            if (this.selectedStudent === null) return;
            axios.post(`http://localhost:3000/grading`, { //TODO json-server won't upsert information with PUT, it only inserts.
                id: `${this.assignmentName}-${this.selectedStudent}`,
                assignmentName: this.assignmentName,
                UVID: this.selectedStudent,
                totalPts: this.totalPts,
                actualPts: this.actualPts,
                selectedRules: this.selectedRules
            })
            .then(function (res) {
                console.log(res);
            })
            .catch(function (err) {
                console.log(err);
            });
        },
        addComment: function() {
          if (this.commentsObj.newComment == "") return;
          this.commentsObj.comments.push({comment: this.commentsObj.newComment, date: new Date()});
          this.commentsObj.newComment = "";
        },
        removeComment: function(i) {
          this.deletedComments.push(this.commentsObj.comments[i]);
          this.commentsObj.comments.splice(i, 1);
        },
        restoreComment: function() {
          this.commentsObj.comments.push(this.deletedComments.pop());
        },
        editComment: function(i) {
          this.activeCommentEdit = i;
          this.activeCommentEditText = this.commentsObj.comments[i].comment;
        },
        submitEditedComment: function(i) {
          this.commentsObj.comments[i].comment = this.activeCommentEditText;
          this.activeCommentEditText = null;
          this.activeCommentEdit = null;
        }
      },
      created: function(){
        let self = this;    //closure - captures the scope of all the variables of 'this' which is the 'created' function.

        //Grab Lab1 info
        axios.get('http://localhost:3000/assignments/Lab1') //TODO dynamically fetch data based on the lab id (Lab1)
        .then(function(res){
            console.log(res.data);
            self.assignmentName = res.data.id;
            self.totalPts = res.data.totalPts;
            self.rules = res.data.rules;
            self.comment = res.data.commentsObj;
        })
        .catch(function(err){
            console.log(err);
        });

        //Grab students for grading
        axios.get('http://localhost:3000/students')
        .then(function(res){
            console.log(res.data);
            self.students = res.data;
        })
        .catch(function(err){
            console.log(err);
        });
      }
    });

    //TEAM MILESTONE
    //TODO save (storing the json) via axios                -- Joseph Stoops
    //TODO recover/restore deleted rule in memory stack     -- Joseph Stoops
    //TODO edit rule
    //TODO edit name                                        -- Joseph Stoops
    //TODO edit totalPts
    //TODO list of comments (no points up or down)
    //TODO edit list of comments (no points up or down)
    //TODO delete list of comments/recovering
    //TODO create a new assignment                          -- Joseph Stoops


    //ITEMS TO TACKLE IN THE FUTURE
    //TODO add a error message that fades away. (save grading with no student selected, restore rule from empty array, etc.)
    //TODO
  </script>
</body>

</html>
