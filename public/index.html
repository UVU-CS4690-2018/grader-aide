<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>GraderAide</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="main.css">

    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13"></script>
    <!-- TODO -->
    <script src="https://unpkg.com/axios@0.17.1/dist/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>

<nav class="navbar navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <a class="navbar-brand brandingNavHdr" href="#">Grader-Aide</a>
        </div>
    </div><!-- /.container-fluid -->
</nav>


    <div class="container" id="app">
        <div class="row" style="margin-top: 15px; color: #9e9e9e;">
            <div class="col align-self-center text-center collapse" id="collapseExample">To undo delete: <span style="color: orange;">Ctrl+Z</span></div>
        </div>
        <div class="row">
            <!-- title row -->

            <div class="col-xl-6 offset-xl-3 margMain">
        <div class="container">
          <div class="row">
            <h2 v-if="!editName" class="assignmentName" @click="editName = !editName;">{{name}}</h2>
            <input style="width: 50%" v-else class="editName textInput" type="text" v-model="name">
            <span v-if="editName" style="padding: 15px;" class="clickable" @click="editName = !editName;">ðŸ’¾</span>
            <img v-else style="padding: 15px;" src="img/pencilBlack.svg" @click="editName = !editName;" class="clickable">
          </div>
        </div>
                <hr class="line">
        <div class="container">
          <div class="row">
            <h4 v-if="!editTotalPts" @click="editTotalPts = !editTotalPts;">{{totalPts}}<span class="ptsPts"> pts</span></h4>
            <input v-else style="width: 20%" class="editTotalPts textInput" type="number" v-model.number="totalPts">
            <span v-if="editTotalPts" style="padding: 15px;" class="clickable" @click="editTotalPts = !editTotalPts;">ðŸ’¾</span>
            <img v-else style="padding: 15px;" src="img/pencilBlack.svg" @click="editTotalPts = !editTotalPts;" class="clickable">
          </div>
        </div>

                <div v-if="!plusFormActive" @click="plusFormActive=true"><img src="img/plusGreen.svg" class="clickable" title="Open Add Fields"></div>


                <!-- rules rows -->
                <div v-for="(rule, i) of rules" :key="rule.desc" class="container ruleRow">
                    <rule v-model="selectedRules" v-bind:rule="rule" v-bind:index="i" v-on:rulechecked="checkrule" v-on:ruleunchecked="uncheckrule" v-on:deleterule="deleteRule" v-on:rulechanged="ruleChanged"></rule>
                </div>

                <!-- add row -->
                <div v-if="plusFormActive">
                    <input class="addRuleNum col-xl-2" type="number" v-model.number.lazy="addNum" @keyup.enter="addRule()" title="pts (positive or negative)">
                    <input class="addRuleDesc col-xl-9" type="text" v-model.trim.lazy="addDesc" @keyup.enter="addRule()" placeholder="Type your new rule here ...">
                    <img src="img/plusGreen.svg" class="clickable float-right" @click="addRule()" title="Add"><br>
                </div>

                <!-- output rows -->
                <div v-if="actualPts < totalPts" class="alert alert-warning margMain" role="alert">
                    <span v-for="selectedRule of selectedRules">{{selectedRule.pts | positive}} {{selectedRule.desc}}<br></span>
                    <hr> {{actualPts}}
                </div>
                <div v-else class="alert alert-success margMain" role="alert">
                    <span v-for="selectedRule of selectedRules">{{selectedRule.pts | positive}} {{selectedRule.desc}}<br></span>
                    <b>Good Job</b>
                    <hr> {{actualPts}}
                </div>
                <button @click="saveChanges()" class="btn btn-success">
                    Save
                </button>
                <button @click="createNewAssignment()" class="btn btn-primary">
                    Create Assignment
                </button>
            </div>
        </div>
    </div>
    <script>

    Vue.component('rule', {

    props: ['rule', 'index'],
    template: `
                <div class="row align-items-center">
                    <label class="switch col-1">
                        <input type="checkbox" @change="check" :value="rule">
                        <span class="slider round"></span>
                    </label>
                    <div class="col-9">
                        <span v-if="!edit" @click="edit = !edit;" style="color: white"><span style="padding-right: 15px; color: white; font-weight: bolder;">{{rule.pts | positive}}</span> {{rule.desc}}</span>
                        <span v-else><input style="width: 50px" class="textInput" type="number" v-model="locPts"><input style="width: 75%" type="text" class="textInput" v-model="locDesc"></span>
                    </div>
                    <div class="col">
                        <img src="img/xRed.svg" class="clickable float-right removeButton" @click="remove" title="Remove">
                        <img v-if="!edit" src="img/pencilBlack.svg" class="clickable float-right" @click="editvalues" title="Edit">
                        <span v-else class="clickable float-right" @click="savevalues">ðŸ’¾</span>
                    </div>
                </div>
`,
    data: function () {
        return {
            id: this._uid,
            edit: false,
            locDesc: this.rule.desc,
            locPts: this.rule.pts,
            checked: false,
            shownUndoTip: false
        }
    },
    filters: {
        positive: function(num) {
            if (num > 0) return `+${num}`;
            return num;
        }
    },
    methods: {
        remove: function () {
            this.$emit('ruleunchecked', { rule: this.rule, id: this.id });
            this.$emit('deleterule', {index: this.index});
            if(!this.shownUndoTip) {
                $('.collapse').collapse();
                this.shownUndoTip = true;
                setTimeout(
                    function() {
                        $('.collapse').collapse('hide');
                    }, 3000);
            }
        },
        editvalues: function () {
            this.edit = !this.edit;
        },
        savevalues: function (event) {
            this.edit = !this.edit;
            let oldDesc = this.rule.desc;
            this.$emit('rulechanged', {desc: this.locDesc, pts: this.locPts, index: this.index});
            if(oldDesc != this.rule.desc) {
                this.$emit('ruleunchecked', { rule: this.rule, id: this.id });
            }
            if (this.checked && oldDesc == this.rule.desc) {
                this.$emit('ruleunchecked', { rule: this.rule, id: this.id });
                this.$emit('rulechecked', { rule: this.rule, id: this.id });
            }
        },
        check: function (event) {
            if(event.target.checked) {
                this.$emit('rulechecked', { rule: this.rule, id: this.id });
                this.checked = true;
            } else {
                this.$emit('ruleunchecked', { rule: this.rule, id: this.id });
                this.checked = false;
            }
        }
    }
})

let app = new Vue({
    el: '#app',
    data: { //persisted data
        name: null,
        totalPts: 0,
        rules: [],
        //temporary gui state
        selectedRules: [],
        addNum: null,
        addDesc: null,
        deletedRuleStack: [],
        plusFormActive: false,
        editName: false,
        editTotalPts: false
    },
    filters: {
        positive: function(num) {
            if (num > 0) return `+${num}`;
            return num;
        }
    },
    computed: {
        actualPts: function() { //add up all selected pts and subtract from totalPts
            return this.selectedRules.reduce((acc, el) => acc + el.pts, this.totalPts);
        }
    },
    methods: {
    deleteRule: function(payload) {
      this.deletedRuleStack.push(this.rules.splice(payload.index,1));
    },
    addRule: function() {
        if (!this.addNum) return;
        if (!this.addDesc) return;
        this.rules.push({
            pts: this.addNum,
            desc: this.addDesc
        });
        this.addNum = null;
        this.addDesc = null;
        this.plusFormActive = false;
    },
    checkrule: function (payload) {
      this.selectedRules.push({id: payload.id, pts: payload.rule.pts, desc: payload.rule.desc});
    },
    uncheckrule: function (payload) {
      this.selectedRules = this.selectedRules.filter(function( obj ) {
          return obj.id !== payload.id;
      });
    },
    ruleChanged: function (payload) {
      let rule = this.rules[payload.index];
      rule.desc = payload.desc;
      rule.pts = parseInt(payload.pts);
    },
    saveChanges: function (event) {
      alert('saving changes');
    },
    createNewAssignment: function() {
      alert('creating new assignment');
    }
    },
        created: function() {
            let self = this;
            window.addEventListener('keydown', function(event) {
                // If Ctrl+Z is pressed
                console.log(event.code);
                if (event.ctrlKey && event.keyCode == 90 && self.deletedRuleStack.length > 0) {
                    let newRule = self.deletedRuleStack.pop();
                    self.rules.push({pts: newRule[0].pts, desc: newRule[0].desc});
                }
            });
            axios.get('lab1.json')
                .then(function(response) {
                    self.name = response.data.name;
                    self.totalPts = response.data.totalPts;
                    self.rules = response.data.rules;
                })
                .catch(function(error) {
                    console.log(error);
                });
            }
        })

    </script>
</body>

</html>